# ex02 知识点讲解：变量 + 多文件编译（细化版）

本章目标：把你在 ex01 学到的“单文件规则”升级成“真实多文件工程构建”。

---

## 1) 本章解决什么问题（先定边界）

ex01 只有一个源码文件，规则简单。  
ex02 进入真实场景：一个程序由多个 `.cpp` 组成。

你要解决 3 件事：

1. 多文件如何编译与链接
2. 参数如何变量化，便于覆盖
3. 头文件依赖如何正确触发重编

---

## 2) 先跑一遍，再看语法

在目录 `ex02_variables` 执行：

```bash
make clean
make
make run
```

你会看到：

- 先生成 `build/main.o`、`build/math_utils.o`
- 再链接成 `calc`
- `run` 时执行 `./calc`

这一步先建立“构建流水线直觉”。

---

## 3) 编译和链接到底有什么区别

### 编译（compile）

把单个源文件变成目标文件：

```bash
g++ ... -c src/main.cpp -o build/main.o
```

`-c` 的意思是“只编译，不链接”。

### 链接（link）

把多个 `.o` 合成可执行文件：

```bash
g++ ... build/main.o build/math_utils.o -o calc
```

这里不带 `-c`，因为要做链接。

---

## 4) Makefile 里这几类变量为什么必要

常见变量：

- `CXX`：编译器（如 `g++`）
- `CXXFLAGS`：编译参数
- `INCLUDES`：头文件路径参数（如 `-Iinclude`）
- `TARGET`：最终产物名
- `SRCS`：源文件列表
- `OBJS`：目标文件列表

核心目的：降低重复与硬编码，便于命令行覆盖。

示例：

```bash
make CXX=clang++
make CXXFLAGS="-O0 -g -std=c++17 -Wall -Wextra"
```

---

## 5) 规则怎么读（逐条）

### 规则 A：编译目标文件

```make
build/main.o: src/main.cpp include/math_utils.h
	$(CXX) $(CXXFLAGS) $(INCLUDES) -c $< -o $@
```

解释：

- 左侧目标：`build/main.o`
- 右侧依赖：`src/main.cpp` + `include/math_utils.h`
- 命令：编译得到 `.o`

### 规则 B：链接最终程序

```make
$(TARGET): $(OBJS)
	$(CXX) $(CXXFLAGS) $^ -o $@
```

解释：

- 左侧目标：`calc`
- 右侧依赖：所有 `.o`
- 命令：链接成可执行文件

---

## 6) 自动变量在本章中的落地语义

- `$@`：当前规则目标（如 `build/main.o` 或 `calc`）
- `$<`：第一个依赖（编译规则里通常是 `.cpp`）
- `$^`：所有依赖（链接规则里通常是多个 `.o`）

所以：

- 编译规则常用 `$<`
- 链接规则常用 `$^`

---

## 7) 为什么这里要手写头文件依赖

如果 `main.cpp` include 了 `math_utils.h`，你不写这个依赖会有风险：

- 改了头文件，`make` 可能不知道要重编 `main.o`
- 导致行为和源码不一致

这一章先手写依赖，下一章会升级为自动依赖（`.d` 文件）。

---

## 8) 输入 `make run` 时 make 的执行链

以 `run: $(TARGET)` 为例：

1. 目标是 `run`
2. 先满足依赖 `calc`
3. 为构建 `calc`，先满足其依赖 `build/*.o`
4. 每个 `.o` 规则里再检查 `.cpp/.h` 时间戳
5. 依赖都满足后，链接 `calc`
6. 最后执行 `./calc`

这就是“依赖图递归 + 最后执行目标命令”。

---

## 9) 常见误区（按你高频问题整理）

- 误区1：写了规则就会每次执行命令  
  - 错。文件目标要看时间戳，最新就跳过
- 误区2：一个 `.cpp` include 了头文件，其他 `.cpp` 就不用 include  
  - 错。每个编译单元独立，谁用谁 include
- 误区3：链接错误就是编译器坏了  
  - 常见原因是漏了某个 `.o`

---

## 10) 你本章要跑的验收命令

```bash
make clean
make
make run
make CXX=clang++
make CXXFLAGS="-O0 -g -std=c++17 -Wall -Wextra"
make run ARGS="10 20"
```

---

## 11) 本章过关线

满足以下 4 条就算通过：

1. 你能口头解释“编译 vs 链接”
2. 你能解释 `$< / $^ / $@` 在本章各自含义
3. 你会用命令行覆盖 `CXX/CXXFLAGS`
4. 你知道为什么头文件依赖必须写
